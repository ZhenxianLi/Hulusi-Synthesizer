% 
% Use the Synthesizer Play a classic chinese hulusi song ‘Bamboo Under the Moonlight
%  合成一首葫芦丝的经典作品 “月光下的凤尾竹”
clc;clear all;close all;
% Initialization
HarmScale=[280.551687532203,145.956027902726,463.663093646505,461.525198485626,269.833131802056,388.171132062961,830.009314852516,816.445679995814,702.44114066789,1094.33937931369;78.5694168840892,247.176850699589,110.70979293948,106.813116505853,102.865305696257,14.6723653364152,11.5368033146553,6.99955669038914,13.1447861391919,31.9592683203829;288.331649592183,8.5681507945158,77.9082535890937,219.818590007465,200.257204013202,390.104271830325,27.9099096901398,17.6787905792049,44.6366280721883,78.5994317298631;46.6469257551598,31.2652454673712,115.260818884912,18.4474454119302,11.4952111235124,28.328049136371,10.3497793068174,8.3953489918406,0,8.98784265756282;14.8729365669815,11.6987774197273,13.529443259248,23.7176788923026,23.5921938734011,31.0633892644879,4.65824373337034,0,4.03537798674671,16.3052580322937;7.97457896484683,148.635144411488,12.0698384410565,7.84742250695596,28.3287675865184,0,0,0,0,0;15.2135908095248,40.2987478421162,18.644850055509,7.31088207496139,3.69650837622255,2.75721846916074,0,0,0,0;8.65261058568635,38.7824198561599,10.227049450741,3.5017820949877,9.5671970797567,2.0766588320748,0,0,0,0;11.2821123376323,71.1627089769327,3.7382397308846,0,0,0,0,0,0,0;0,6.36570674348231,0,0,0,0,0,0,0,0;2.32140946042514,4.92549683134591,4.16140855659981,0,0,0,0,0,0,0;0,1.24041564923475,0,0,0,0,0,0,0,0;0,4.65529952076347,0,0,0,0,0,0,0,0;0,3.52692629344556,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0;0,1.39758599949513,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0];
Fs =  44100;     % Hz/sample rate


%[note Number,note play time]
MyMidiYueguang=[    5,0.5;
                3,0.5;
                3,0.5;
                5,0.5;
                5,1;%
                5,0.5;
                6,0.5;
                6,0.5;
                7,0.5;
                7,1;%
                7,0.5;
                6,0.5;
                6,0.5;
                5,0.5;
                5,0.5;
                3,0.5;%
                3,0.25;
                5,1.75;
                6,0.5;
                5,0.5;%
                5,0.25;
                3,5.75];


% % test note
% note = 6;          % No. number of note
% lastTime =  1;            % s/ time
% y = playHulusiNote(note,lastTime,Fs,HarmScale);
% soundsc(y,Fs);
% 


% Play song
playSpeed=105;
paiTime=60/playSpeed;
timeLength=paiTime*sum(MyMidiYueguang(:,2));
y=zeros(ceil(timeLength*Fs),1); % Initialization output samples
p=0; % samples locations


for k=1:length(MyMidiYueguang)
    x = playHulusiNote(MyMidiYueguang(k,1),paiTime * MyMidiYueguang(k,2),Fs,HarmScale);
    x=x';
    y(p+1:p+length(x))=x;
    p=p+length(x);
end


%fade out 长音
fadeOutTime=4 *paiTime;     % pai
fadeOutSamples=floor(4*Fs);
fadeOutWindow=linspace(1, 0, fadeOutSamples);
fadeOutWindow=fadeOutWindow';
y(end-fadeOutSamples+1:end) =  y(end-fadeOutSamples+1:end) .* fadeOutWindow;  % 应用fade-out




soundsc(y,Fs);
